<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <style>
    body {
      height: 400vh;
    }
    #ifr {
      display: none;
    }
  </style>
</head>

<body>
  <h1 id="native">native</h1>
  <iframe id="ifr" src=""></iframe>
</body>
<script>
  var timeout = 500;
  let hide = false;
  document.getElementById("native").onclick = function () {
    var schema = `coinmarketcap://coinmarketcap.com/link`;
    var start = Date.now();
    var timeDiff = 100;
    var timer = setTimeout(() => {
      if (Date.now() - start > timeout + timeDiff) clearTimeout(timer);
      var appStore = "https://apps.apple.com/app/coinmarketcap/id1282107098?ls=1";
      var googleplay = "https://play.google.com/store/apps/details?id=com.coinmarketcap.android";
      var inIos = navigator.userAgent.toLowerCase().includes('iphone');
      !hide && tryCallApp(inIos ? appStore : googleplay);
    }, timeout);
    tryCallApp(schema);
  };
  
  document.addEventListener("visibilitychange", function() {
    if (document.visibilityState == 'hidden') {
      hide = true;
      clearTimeout(timer);
    } 
  });

  function tryCallApp(schema) {
    setTimeout(() => {
      document.getElementById('ifr').src = schema;
    }, 0);
    setTimeout(() => {
      location.href = schema;
    }, 0);
  }
</script>

</html>
